# 아키텍처 개요

## 애플리케이션 구성
- **정적 단일 페이지 앱**: `index.html`은 시각화 셸을 불러오며, 스타일시트를 연결하고 D3.js v7을 CDN에서 불러온 후 `script.js`를 부트스트랩하여 동작을 시작합니다. 【F:index.html†L1-L57】
- **이중 SVG 레이아웃**: 페이지는 전체 화면 배경용 `<svg>`와, 사용자가 상호작용하는 원형 `.scene-container` 안의 전경 `<svg>`를 정의합니다. 전경 SVG는 글로우 효과에 사용되는 공유 SVG 필터들도 선언합니다. 【F:index.html†L10-L25】
- **모달 에셋**: 숨겨진 `.popup` 컨테이너는 비디오 요소와 이미지 폴백, 투명한 `#hotspotLayer` 오버레이를 보유하며, 스크립트 기반 이벤트로 토글됩니다. 비디오는 자동 재생 대신 스크롤 스크럽을 전제로 합니다.

## 데이터 & Force 시뮬레이션 흐름
- **유니버스 그래프 모델**: `script.js`는 페르소나와 다중 우주 관계를 설명하는 `nodes` 및 `links` 배열을 병렬로 선언합니다. 각 노드는 `video` 메타데이터(소스 경로, 길이)와 선택적 `hotspots` 정의(timeRange, 정규화 좌표, 타깃 노드)를 포함합니다. 분위기 연출을 위한 엔트리는 `decorative: true` 플래그와 `appearance.opacity`(기본 0.3), `appearance.scale`(0.9)을 사용해 정의되며, 팝업과 라벨 렌더링에서 제외됩니다.
- **점진적 링크 생성**: 초기 진입 시 `links` 배열은 비어 있거나 비활성화된 상태로 렌더링되어 모든 노드가 고립된 점으로 나타나며, 핫스팟 상호작용이 발생할 때마다 현재 노드와 대상 노드 간 연결을 추가합니다. 중복 연결은 `(source,target)` 쌍으로 검사하고, 새 링크는 전경/배경 레이어에 즉시 반영됩니다.
- **D3 force 레이아웃**: `d3.forceSimulation`은 `forceLink`, `forceManyBody`, `forceCenter`, `forceRadial` 동작을 조합하여 노드들을 방사형 레이더 구조 내에 배치하면서 네트워크 토폴로지를 유지합니다. 【F:script.js†L24-L45】【F:script.js†L193-L197】
- **계층 렌더링**: 배경 및 전경 SVG 그룹은 동일한 데이터를 반영합니다. 배경 요소는 부드러운 앰비언트 네트워크를 제공하고, 전경 레이어는 인터랙티브한 원형 및 라벨을 추가합니다. 장식용 노드는 `.node--decorative` 클래스로 분리되어 낮은 알파와 포인터 차단이 적용되며, 라벨 셀렉션에서는 숨김 처리됩니다. 새로 생성된 노드는 데이터 조인 재평가(`selection.join`)를 통해 두 레이어 모두에 동적으로 합류합니다.
- **인터랙티브 드래그**: 재사용 가능한 `drag` 헬퍼가 D3의 드래그 이벤트를 연결하여 사용자가 노드를 재배치할 수 있게 합니다. 드래그가 끝나면 물리 엔진이 위치를 안정화합니다. 【F:script.js†L116-L138】
- **팝업 워크플로우**: 노드를 클릭하면 `showPopupForNode`가 호출되어 비디오 소스를 주입하고, 스크롤 기반 재생 제어와 핫스팟 표시 로직을 초기화합니다. `hidePopup` 또는 `Escape` 키로 닫히며, 비디오/리스너 리소스가 해제됩니다.

## 인터랙티브 미디어 제어
- **스크롤-시간 매핑**: 팝업이 열린 동안 전역(또는 지정 컨테이너) 스크롤 비율을 비디오 길이에 매핑하여 `currentTime`을 업데이트합니다. `requestAnimationFrame`을 이용해 스크롤 이벤트를 스로틀링합니다.
- **핫스팟 레이어**: 현재 비디오 프레임 시간이 `hotspots`의 `timeRange` 안에 들어오면 `#hotspotLayer`에 절대 배치된 `<div>`를 생성해 클릭 영역을 구성합니다. 클릭 시 대상 노드를 찾거나 생성하고, force 시뮬레이션을 재가열합니다.
- **동적 노드 생성**: 핫스팟으로 생성된 노드는 `nodes`/`links` 배열에 푸시된 뒤, 데이터 조인과 시뮬레이션을 갱신하여 즉시 시각화에 반영합니다.
- **감각 피드백 계층**: `sounds/tick.wav`를 `<audio>` 또는 WebAudio 버퍼로 로드하여 스크롤 이벤트와 클릭 액션에서 공유하고, 스크롤 속도에 따라 `playbackRate`를 0.8~1.3 범위로 조절합니다. 모바일 환경에서는 `navigator.vibrate(10)` 호출로 진동을 동기화하되, 미지원 환경에서는 예외 없이 무시합니다.

## 제작자 지원 도구
- **핫스팟 인스펙터**: 단축키 `I`로 토글되는 디버그 모드를 통해 `[`, `]` 키로 프레임을 미세 이동하고, 드래그 박스로 영역을 지정해 정규화 좌표 및 권장 `timeRange` JSON을 콘솔과 클립보드로 추출합니다.

## 축하 시퀀스
- **트리거 조건**: 모든 인터랙티브 노드가 단일 연결 요소로 합쳐지고, 사용자가 각 노드를 최소 한 번씩 연 뒤에 세션당 한 번만 축하 시퀀스를 실행합니다.
- **연출 흐름**: 축하 트리거가 발생하면 기존 팝업을 닫고 `I love you_speech.mp4` 팝업을 전체 화면으로 띄우며, 동시에 force 시뮬레이션을 감쇠시킨 뒤 1초간 도넛 형태 좌표로 재배치하고, 이어 2초간 하트 곡선으로 인터폴레이션합니다.
- **복귀 처리**: 애니메이션 종료 후 force 시뮬레이션 파라미터를 원래 값으로 복구하고, 사용자가 팝업을 닫거나 영상을 재시작할 수 있도록 UI 컨트롤을 제공합니다.

## 반응형 동작 및 레이아웃
- **레이더 동기화**: `syncRadarToContainer`는 창 크기가 변경될 때마다 SVG 뷰박스, 방사형 force, 펄스 링 크기를 재계산하며, 초기 로드시 노드들을 레이더 내부에 시딩합니다. 【F:script.js†L162-L214】
- **뷰포트 리스너**: 스크립트는 `resize` 이벤트를 감지하고, 즉시 동기화 루틴을 실행하여 force 레이아웃이 현재 뷰포트에 맞춰지도록 합니다. 【F:script.js†L227-L229】
- **스타일링 시스템**: `style.css`는 테마 변수, 네온 HUD 스타일(현재는 HTML에서 주석 처리됨), 원형 레이더 컨테이너, 맥박 링, 팝업 표시 스타일 등을 정의합니다. 각 레이어는 믹스 블렌드 모드와 그라디언트를 활용해 SF적 미학을 구현합니다. 【F:style.css†L1-L157】【F:style.css†L176-L237】
